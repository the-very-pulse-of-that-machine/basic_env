apiVersion: batch/v1
kind: Job
metadata:
  # ğŸ”´ [å¿…å¡«] ä½œä¸šåç§°å»ºè®®åŒ…å«ä¸ªäººæ ‡è¯†ï¼Œé˜²æ­¢é‡åå†²çª
  name: 91mrqiao-basic-job
  namespace: default
  labels:
    app: train-job
    # ğŸŸ¢ [å¿…å¡«] Job è‡ªèº«å¿…é¡»å¸¦æ ‡ç­¾ (ä¸ºäº†é€šè¿‡ Job Admission Policy)
    eks.ebcloud.com/prepaid: "true"
spec:
  # âœ… Job æ€»å…±å…è®¸è·‘ 7 å¤© (7 * 24 * 3600)
  activeDeadlineSeconds: 604800

  # âœ… [æ ¸å¿ƒ] å…è®¸é‡è¯•æ¬¡æ•° (ä¹Ÿå°±æ˜¯å…è®¸â€œè½®è½¬â€çš„æ¬¡æ•°)
  # æ¯”å¦‚ä½ æƒ³è·‘ 5 å¤©ï¼Œæ¯å¤©é‡å¯ä¸€æ¬¡ï¼Œè¿™é‡Œè‡³å°‘è®¾ä¸º 5ï¼Œå»ºè®®è®¾å¤§ä¸€ç‚¹å®¹é”™
  backoffLimit: 10

  # âœ… [æ¸…ç†] ä»»åŠ¡å®Œæˆå(æ— è®ºæˆåŠŸå¤±è´¥) 10åˆ†é’Ÿè‡ªåŠ¨åˆ é™¤ Job å¯¹è±¡ï¼Œé˜²æ­¢å†å²è®°å½•å †ç§¯
  ttlSecondsAfterFinished: 600

  template:
    metadata:
      labels:
        app: train-job
        # ğŸŸ¢ [å¿…é¡»] Pod æ¨¡æ¿ä¹Ÿå¿…é¡»å¸¦æ ‡ç­¾ï¼(ä¸ºäº†é€šè¿‡ Pod ç­–ç•¥)
        # âš ï¸ å¦‚æœæ¼æ‰è¿™é‡Œï¼ŒJob Controller åˆ›å»º Pod æ—¶ä¼šè¢« Admission Webhook æ‹’ç»
        eks.ebcloud.com/prepaid: "true"
    spec:
      # âœ… [æ ¸å¿ƒ] å¤±è´¥åé‡å¯ (åˆ›å»ºæ–° Pod æ’é˜Ÿ)
      restartPolicy: OnFailure

      # âœ… Job å•è½®æ¬¡å…è®¸è·‘ 4h (4 * 3600)
      activeDeadlineSeconds: 14400
      
      imagePullSecrets:
        - name: aliyun-regcred

      # èŠ‚ç‚¹äº²å’Œæ€§è®¾ç½® (ç”¨äºæŒ‡å®š GPU å‹å·)ã€‚ä¸è¦è°ƒæ•´ï¼Œç›®å‰èŠ‚ç‚¹æ± å†…åªæœ‰ A800 èŠ‚ç‚¹
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: cloud.ebtech.com/gpu
                    operator: In
                    values:
                      - A800_NVLINK_80GB
                  # ğŸŸ¡ [å»ºè®®] å¦‚æœå› ä¸ºé©±åŠ¨å‡çº§å¯¼è‡´ Pod æ— æ³•è°ƒåº¦ï¼Œè¯·æ³¨é‡Šæ‰ä¸‹æ–¹é©±åŠ¨ç‰ˆæœ¬é™åˆ¶
                  - key: cloud.ebtech.com/gpu-driver
                    operator: In
                    values:
                      - 580.65.06

      containers:
      - name: 91mrqiao-job-container
        image: crpi-4h7f6m1tjs5g4t58.cn-hangzhou.personal.cr.aliyuncs.com/91_mrqiao/basic_env:devel
        imagePullPolicy: IfNotPresent

        # ğŸ”´ è®¾ç½®å·¥ä½œç›®å½•ï¼Œé¿å…å‘½ä»¤é‡Œå†™é•¿è·¯å¾„
        workingDir: /workspace/qiaohansheng/
        # =========================================================
        # ğŸŸ¢ [æ ¸å¿ƒé»‘ç§‘æŠ€] ä¸æ”¹ä»£ç å®ç°è‡ªåŠ¨è½®è½¬
        # =========================================================
        # è§£é‡Šï¼š
        # timeout -s SIGTERM 14200s: è¿è¡Œ 14200ç§’ (çº¦3.8å°æ—¶)
        # bash train_job.sh: å®é™…çš„è®­ç»ƒè„šæœ¬
        #
        # é€»è¾‘ï¼š
        # 1. å¦‚æœè®­ç»ƒåœ¨ 3.8å°æ—¶å†…å®Œæˆäº† -> è¿”å› 0 -> Job æˆåŠŸç»“æŸã€‚
        # 2. å¦‚æœè¶…è¿‡ 3.8å°æ—¶ -> timeout æ€æ‰è¿›ç¨‹ -> è¿”å› 124 (é”™è¯¯) -> K8s è®¤ä¸ºå¤±è´¥ -> è§¦å‘é‡å¯æ’é˜Ÿï¼
        # 3. åˆ°è¾¾æ—¶é—´æ—¶ timeout ä¼šå…ˆå‘é€ä¸€ä¸ª SIGTERM ä¿¡å·ï¼Œå¦‚æœä½ æƒ³å¤„ç†çš„è¯ï¼Œ
        #    åœ¨ Python é‡Œå¯ä»¥ catch åˆ°è¿™ä¸ªä¿¡å·åä¿å­˜æ¨¡å‹ã€‚ï¼ˆå¯é€‰ï¼‰
        # =========================================================
        command: ["/bin/bash", "-c"]
        args:
          - |
            
            source /workspace/qiaohansheng/.bashrc_persist
            conda activate uva
            cd unified_video_action_hot
            accelerate launch --num_processes=4 train.py     --config-dir=.     --config-name=uva_expand_hot_pusht.yaml     model.policy.action_model_params.predict_action=False     model.policy.selected_training_mode=video_model    model.policy.autoregressive_model_params.hot_select_ratio=0.1    model.policy.optimizer.learning_rate=1e-4     logging.project=uva_tune     hydra.run.dir="checkpoints/test1_video_only_tune_01ratio_expand_hot"


        resources:
          limits:
            nvidia.com/gpu: "4"
            cpu: "10"
            memory: 100Gi

        volumeMounts:
        # 1. ä¸ªäººå·¥ä½œåŒº (è¯»å†™)
        - name: workspace-volume
          mountPath: /workspace
        # 2. æ•°æ®é›† (è°¨æ…è¯»å†™)
        - name: dataset-volume
          mountPath: /dataset
        # 3. å…¬å…±ç›˜ (å¿…é¡»åªè¯»)ï¼Œäº‘å¹³å°æä¾›
        - name: public-volume
          mountPath: /public
          readOnly: true  # ğŸ›¡ï¸ [å®‰å…¨å¼ºåˆ¶] é˜²æ­¢è¯¯åˆ ç‰©ç†æœºæ–‡ä»¶ï¼
        
        - mountPath: /dev/shm
          name: dshm

      volumes:
      - name: workspace-volume
        persistentVolumeClaim:
          claimName: cvrlab-workspace
      - name: dataset-volume
        persistentVolumeClaim:
          claimName: cvrlab-dataset
      # æŒ‚è½½å®¿ä¸»æœºç›®å½•ï¼ˆäº‘å¹³å°æä¾›ï¼‰
      - name: public-volume
        hostPath:
          path: /public
          type: Directory
      - name: dshm
        emptyDir:
          medium: Memory
          sizeLimit: 16Gi
